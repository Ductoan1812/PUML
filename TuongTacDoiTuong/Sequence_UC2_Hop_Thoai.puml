@startuml Sequence_UC2_Hop_Thoai
!theme plain

title Biểu đồ Trình tự - UC Hộp Thoại

actor Player
participant "Giao diện" as UI
participant "Hệ thống" as System
database "DataBase" as DB

Player -> UI: 1. Tương tác với NPC
activate UI
UI -> System: 2. Yêu cầu dialogue
activate System

System -> DB: 3. Kiểm tra NPC dialogue data
activate DB
DB --> System: 4. Trả về dialogue info
deactivate DB

alt NPC có dialogue
    System --> UI: 5. Hiển thị dialogue interface
    UI --> Player: 6. Xem text và portrait
    
    Player -> UI: 7. Chọn response option
    UI -> System: 8. Process response
    
    System -> DB: 9. Lấy next dialogue node
    activate DB
    
    alt dialogue OK
        DB --> System: 10. Trả về next node
        deactivate DB
        
        System --> UI: 11. Hiển thị next dialogue
        
        alt dẫn đến quest
            UI --> Player: 12. Chuyển đến quest system
            
        else dẫn đến shop
            UI --> Player: 13. Mở shop interface
            
        else kết thúc
            UI --> Player: 14. Đóng dialogue
        end
        
    else dialogue lỗi
        DB --> System: 15. Lỗi dialogue data
        deactivate DB
        
        System -> System: 16. Log lỗi
        System --> UI: 17. Hiển thị default text
        UI --> Player: 18. Text mặc định
    end
    
else NPC không có dialogue
    System --> UI: 19. Thông báo mặc định
    UI --> Player: 20. Hiển thị generic message
end

deactivate System
deactivate UI

@enduml

